import json
from tqdm import tqdm
from glob import glob
from itertools import combinations

no_belt = [
	'20230619_101843',
	'20230619_103633',
	'20230619_103724',
	'20230619_103811',
	'20230619_103910',
	'20230619_104023',
	'20230619_104042',
	'20230619_104126',
	'20230619_104809',
	'20230619_104838',
	'20230619_104915',
	'20230619_105052',
	'20230619_105155',
	'20230619_105214',
	'20230619_105248',
	'20230619_110021',
	'20230619_111942',
	'20230619_112036',
	'20230619_112134',
	'20230619_112249',
	'20230619_112312',
	'20230619_112400',
	'20230619_112951',
	'20230619_113022',
	'20230619_113131',
	'20230619_113236',
	'20230619_113348',
	'20230619_113410',
	'20230619_113447',
	'20230619_011747',
	'20230619_011833',
	'20230619_011946',
	'20230619_012100',
	'20230619_012236',
	'20230619_012300',
	'20230619_012415',
	'20230619_012635',
	'20230619_014135',
	'20230619_014210',
	'20230619_014247',
	'20230619_014327',
	'20230619_014609',
	'20230619_014727',
	'20230619_014809',
	'20230619_022300',
	'20230619_022338',
	'20230619_022410',
	'20230619_022452',
	'20230619_022639',
	'20230619_022800',
	'20230619_022844',
	'20230619_023946',
	'20230619_024021',
	'20230619_024135',
	'20230619_024236',
	'20230619_024318',
	'20230619_024433',
	'20230619_024511',
	'20230620_104141',
	'20230620_104240',
	'20230620_104339',
	'20230620_104447',
	'20230620_104606',
	'20230620_104650',
	'20230620_104725',
	'20230620_105558',
	'20230620_105644',
	'20230620_105736',
	'20230620_105829',
	'20230620_105929',
	'20230620_110045',
	'20230620_110120',
	'20230620_112509',
	'20230620_112617',
	'20230620_112723',
	'20230620_112842',
	'20230620_113027',
	'20230620_113124',
	'20230620_113211',
	'20230620_113241',
	'20230620_113837',
	'20230620_113917',
	'20230620_114009',
	'20230620_114101',
	'20230620_114151',
	'20230620_114320',
	'20230620_114345',
	'20230620_012756',
	'20230620_012907',
	'20230620_013110',
	'20230620_013156',
	'20230620_013254',
	'20230620_013337',
	'20230620_013407',
	'20230620_020038',
	'20230620_020134',
	'20230620_020157',
	'20230620_020247',
	'20230620_020427',
	'20230620_020513',
	'20230620_020540',
	'20230620_020600',
	'20230620_021139',
	'20230620_022247',
	'20230620_023029',
	'20230620_023100',
	'20230620_023150',
	'20230620_023235',
	'20230620_023324',
	'20230620_023403',
	'20230620_023426',
	'20230620_025116',
	'20230620_025144',
	'20230620_025225',
	'20230620_025304',
	'20230620_025354',
	'20230620_025428',
	'20230620_025450',
	'20230621_111241',
	'20230621_111355',
	'20230621_111528',
	'20230621_111629',
	'20230621_111725',
	'20230621_111805',
	'20230621_111832',
	'20230621_112549',
	'20230621_112632',
	'20230621_112711',
	'20230621_112802',
	'20230621_112852',
	'20230621_112941',
	'20230621_113008',
	'20230621_114022',
	'20230621_114140',
	'20230621_114221',
	'20230621_114316',
	'20230621_114401',
	'20230621_114456',
	'20230621_114507',
	'20230621_114552',
	'20230621_114619',
	'20230621_115227',
	'20230621_115257',
	'20230621_115331',
	'20230621_115429',
	'20230621_115520',
	'20230621_115600',
	'20230621_115627',
	'20230621_014328',
	'20230621_014411',
	'20230621_014510',
	'20230621_014606',
	'20230621_014651',
	'20230621_014749',
	'20230621_014840',
	'20230621_014906',
	'20230621_015450',
	'20230621_015526',
	'20230621_015600',
	'20230621_015647',
	'20230621_015738',
	'20230621_015813',
	'20230621_015839',
	'20230621_021630',
	'20230621_021718',
	'20230621_021822',
	'20230621_021907',
	'20230621_021956',
	'20230621_022012',
	'20230621_022038',
	'20230621_022544',
	'20230621_022612',
	'20230621_022648',
	'20230621_022733',
	'20230621_022821',
	'20230621_022846',
	'20230621_022914',
	'20230705_085958',
	'20230705_090108',
	'20230705_090356',
	'20230705_090518',
	'20230705_090743',
	'20230705_090810',
	'20230705_090858',
	'20230705_091735',
	'20230705_091821',
	'20230705_091909',
	'20230705_092025',
	'20230705_092155',
	'20230705_092216',
	'20230705_092302',
	'20230705_093224',
	'20230705_093339',
	'20230705_094402',
	'20230705_094508',
	'20230705_094657',
	'20230705_094823',
	'20230705_094846',
	'20230705_094936',
	'20230705_095647',
	'20230705_095724',
	'20230705_095822',
	'20230705_095925',
	'20230705_100040',
	'20230705_100102',
	'20230705_100140',
	'20230705_102210',
	'20230705_102238',
	'20230705_102317',
	'20230705_102358',
	'20230705_102503',
	'20230705_102622',
	'20230705_102647',
	'20230705_102728',
	'20230705_103420',
	'20230705_103503',
	'20230705_103552',
	'20230705_103845',
	'20230705_104001',
	'20230705_104024',
	'20230705_104104',
	'20230705_110940',
	'20230705_111014',
	'20230705_111053',
	'20230705_111155',
	'20230705_111317',
	'20230705_111335',
	'20230705_111417',
	'20230705_112059',
	'20230705_112131',
	'20230705_112352',
	'20230705_112458',
	'20230705_112629',
	'20230705_112648',
	'20230705_112740',
	'20230705_014501',
	'20230705_014617',
	'20230705_014800',
	'20230705_014933',
	'20230705_015219',
	'20230705_015359',
	'20230705_015430',
	'20230705_015519',
	'20230705_021203',
	'20230705_021304',
	'20230705_021414',
	'20230705_021535',
	'20230705_021700',
	'20230705_021728',
	'20230705_021838',
	'20230705_022333',
	'20230705_022505',
	'20230705_022655',
	'20230705_022806',
	'20230705_022932',
	'20230705_023122',
	'20230705_023159',
	'20230705_023248',
	'20230705_024243',
	'20230705_024355',
	'20230705_024455',
	'20230705_024714',
	'20230705_024845',
	'20230705_024912',
	'20230705_025000',
	'20230705_031750',
	'20230705_031847',
	'20230705_031947',
	'20230705_032223',
	'20230705_032352',
	'20230705_032427',
	'20230705_032509',
	'20230705_033608',
	'20230705_033701',
	'20230705_033758',
	'20230705_033920',
	'20230705_034053',
	'20230705_034221',
	'20230705_034303',
	'20230705_040901',
	'20230705_040945',
	' 20230705_041043',
	' 20230705_041205',
	' 20230705_041343',
	'20230705_041432',
	'20230705_041518',
	'20230705_042625',
	'20230705_042729',
	'20230705_042835',
	'20230705_042953',
	'20230705_043120',
	'20230705_043211',
	'20230705_043257',
	'20230706_014124',
	'20230706_014447',
	'20230706_014535',
	'20230706_014733',
	'20230706_014849',
	'20230706_014921',
	'20230706_015006',
	'20230706_015752',
	'20230706_015836',
	'20230706_015919',
	'20230706_020345',
	'20230706_020506',
	'20230706_020528',
	'20230706_020610',
	'20230706_020659',
	'20230706_022158',
	'20230706_022247',
	'20230706_022329',
	'20230706_022420',
	'20230706_022609',
	'20230706_022720',
	'20230706_022742',
	'20230706_022823',
	'20230706_023437',
	'20230706_023600',
	'20230706_023711',
	'20230706_023813',
	'20230706_023920',
	'20230706_023941',
	'20230706_024024',
	'20230706_030337',
	'20230706_030445',
	'20230706_030537',
	'20230706_030646',
	'20230706_030757',
	'20230706_030823',
	'20230706_030904',
	'20230706_032120',
	'20230706_032351',
	'20230706_032457',
	'20230706_032606',
	'20230706_032711',
	'20230706_032737',
	'20230706_032813',
	'20230706_035413',
	'20230706_035454',
	'20230706_035551',
	'20230706_035656',
	'20230706_035805',
	'20230706_035835',
	'20230706_035913',
	'20230706_040550',
	'20230706_040627',
	'20230706_040738',
	'20230706_040841',
	'20230706_041007',
	'20230706_041041',
	'20230706_041119',
	'20230709_085221',
	'20230709_085310',
	'20230709_085602',
	'20230709_085722',
	'20230709_085841',
	'20230709_085957',
	'20230709_090028',
	'20230709_090858',
	'20230709_090933',
	'20230709_091017',
	'20230709_091108',
	'20230709_091202',
	'20230709_091218',
	'20230709_091245',
	'20230709_091818',
	'20230709_091905',
	'20230709_091953',
	'20230709_092053',
	'20230709_092137',
	'20230709_092153',
	'20230709_092214',
	'20230709_092242',
	'20230709_092905',
	'20230709_092949',
	'20230709_093022',
	'20230709_093059',
	'20230709_093147',
	'20230709_093227',
	'20230709_093251',
	'20230709_100045',
	'20230709_100113',
	'20230709_100158',
	'20230709_100224',
	'20230709_100258',
	'20230709_100406',
	'20230709_100430',
	'20230709_100945',
	'20230709_101012',
	'20230709_101042',
	'20230709_101103',
	'20230709_101127',
	'20230709_101228',
	'20230709_101246',
	'20230709_102709',
	'20230709_102730',
	'20230709_102755',
	'20230709_102820',
	'20230709_102926',
	'20230709_103018',
	'20230709_103043',
	'20230709_103504',
	'20230709_103520',
	'20230709_103541',
	'20230709_103606',
	'20230709_103631',
	'20230709_103725',
	'20230709_103751',
	'20230710_084956',
	'20230710_085029',
	'20230710_085105',
	'20230710_085247',
	'20230710_085346',
	'20230710_085404',
	'20230710_085437',
	'20230710_090038',
	'20230710_090110',
	'20230710_090147',
	'20230710_090239',
	'20230710_090342',
	'20230710_090538',
	'20230710_090639',
	'20230710_090721',
	'20230710_091508',
	'20230710_091632',
	'20230710_091718',
	'20230710_091811',
	'20230710_091914',
	'20230710_091937',
	'20230710_092012',
	'20230710_092935',
	'20230710_093004',
	'20230710_093042',
	'20230710_093131',
	'20230710_093226',
	'20230710_093245',
	'20230710_093323',
	'20230710_095430',
	'20230710_095534',
	'20230710_095653',
	'20230710_095740',
	'20230710_095818',
	'20230710_095945',
	'20230710_100018',
	'20230710_100843',
	'20230710_101005',
	'20230710_101039',
	'20230710_101104',
	'20230710_101144',
	'20230710_101324',
	'20230710_101353',
	'20230710_103148',
	'20230710_103227',
	'20230710_103311',
	'20230710_103341',
	'20230710_103657',
	'20230710_103816',
	'20230710_103848',
	'20230710_104641',
	'20230710_104719',
	'20230710_104805',
	'20230710_104839',
	'20230710_104949',
	'20230710_105104',
	'20230710_105141',
	'20230710_105222',
	'20230711_015615',
	'20230711_015705',
	'20230711_015746',
	'20230711_015841',
	'20230711_015958',
	'20230711_020018',
	'20230711_020045',
	'20230711_020718',
	'20230711_020748',
	'20230711_020819',
	'20230711_020859',
	'20230711_021008',
	'20230711_021023',
	'20230711_021051',
	'20230711_021712',
	'20230711_021840',
	'20230711_021921',
	'20230711_022014',
	'20230711_022144',
	'20230711_022204',
	'20230711_022310',
	'20230711_022855',
	'20230711_022932',
	'20230711_023007',
	'20230711_023133',
	'20230711_023245',
	'20230711_023325',
	'20230711_023429',
	'20230711_024748',
	'20230711_024824',
	'20230711_024929',
	'20230711_025014',
	'20230711_025100',
	'20230711_025220',
	'20230711_025256',
	'20230711_025406',
	'20230711_025505',
	'20230711_025650',
	'20230711_025732',
	'20230711_025834',
	'20230711_025947',
	'20230711_030016',
	'20230712_085850',
	'20230712_090052',
	'20230712_090144',
	'20230712_090322',
	'20230712_090441',
	'20230712_090508',
	'20230712_090539',
	'20230712_091329',
	'20230712_091414',
	'20230712_091506',
	'20230712_091620',
	'20230712_091718',
	'20230712_091735',
	'20230712_091802',
	'20230712_093433',
	'20230712_093454',
	'20230712_093604',
	'20230712_093648',
	'20230712_093732',
	'20230712_093829',
	'20230712_093846',
	'20230712_093909',
	'20230712_094515',
	'20230712_094554',
	'20230712_094631',
	'20230712_094713',
	'20230712_094807',
	'20230712_094841',
	'20230712_094910',
	'20230712_100848',
	'20230712_100954',
	'20230712_101146',
	'20230712_101255',
	'20230712_101334',
	'20230712_101521',
	'20230712_101602',
	'20230712_101657',
	'20230712_101736',
	'20230712_101807',
	'20230712_101831',
	'20230712_101857',
	'20230712_102024',
	'20230712_102048',
	'20230715_014110',
	'20230715_014152',
	'20230715_014251',
	'20230715_014536',
	'20230715_014638',
	'20230715_014701',
	'20230715_014756',
	'20230715_015426',
	'20230715_015502',
	'20230715_015541',
	'20230715_015634',
	'20230715_015731',
	'20230715_015748',
	'20230715_015822',
	'20230715_015903',
	'20230715_020706',
	'20230715_020754',
	'20230715_020830',
	'20230715_021034',
	'20230715_021124',
	'20230715_021214',
	'20230715_021303',
	'20230715_022531',
	'20230715_022600',
	'20230715_022630',
	'20230715_022721',
	'20230715_022811',
	'20230715_022828',
	'20230715_022855',
	'20230715_025047',
	'20230715_025121',
	'20230715_025231',
	'20230715_025313',
	'20230715_025359',
	'20230715_025501',
	'20230715_025533',
	'20230715_030637',
	'20230715_030706',
	'20230715_030736',
	'20230715_030805',
	'20230715_030832',
	'20230715_030924',
	'20230715_031015',
	'20230716_021927',
	'20230716_022018',
	'20230716_022055',
	'20230716_022149',
	'20230716_022250',
	'20230716_022311',
	'20230716_022340',
	'20230716_023002',
	'20230716_023111',
	'20230716_023141',
	'20230716_023332',
	'20230716_023437',
	'20230716_023502',
	'20230716_023533',
	'20230716_025221',
	'20230716_025303',
	'20230716_025345',
	'20230716_025426',
	'20230716_025505',
	'20230716_025637',
	'20230716_025756',
	'20230716_030826',
	'20230716_030914',
	'20230716_030956',
	'20230716_031027',
	'20230716_031112',
	'20230716_031257',
	'20230716_031356',
	'20230717_084914',
	'20230717_085006',
	'20230717_085059',
	'20230717_085256',
	'20230717_085400',
	'20230717_085421',
	'20230717_085456',
	'20230717_090233',
	'20230717_090310',
	'20230717_090349',
	'20230717_090437',
	'20230717_090540',
	'20230717_090558',
	'20230717_090628',
	'20230717_090724',
	'20230717_091722',
	'20230717_091820',
	'20230717_091934',
	'20230717_092026',
	'20230717_092133',
	'20230717_092154',
	'20230717_092229',
	'20230717_092854',
	'20230717_092947',
	'20230717_093040',
	'20230717_093121',
	'20230717_093219',
	'20230717_093243',
	'20230717_093316',
	'20230717_100214',
	'20230717_100256',
	'20230717_100403',
	'20230717_100458',
	'20230717_100614',
	'20230717_100727',
	'20230717_100808',
	'20230717_101519',
	'20230717_101554',
	'20230717_101641',
	'20230717_101739',
	'20230717_101819',
	'20230717_101927',
	'20230717_102003',
	'20230717_103743',
	'20230717_103810',
	'20230717_103847',
	'20230717_103920',
	'20230717_103950',
	'20230717_104055',
	'20230717_104123',
	'20230717_104739',
	'20230717_104807',
	'20230717_104840',
	'20230717_104916',
	'20230717_104957',
	'20230717_105125',
	'20230717_105157',
	'20230717_105235',
	'20230718_074315',
	'20230718_074407',
	'20230718_074553',
	'20230718_074743',
	'20230718_074848',
	'20230718_074909',
	'20230718_074940',
	'20230718_075738',
	'20230718_075819',
	'20230718_075906',
	'20230718_080046',
	'20230718_080152',
	'20230718_080213',
	'20230718_080244',
	'20230718_080320',
	'20230718_081631',
	'20230718_081843',
	'20230718_081939',
	'20230718_082034',
	'20230718_082145',
	'20230718_082238',
	'20230718_082319',
	'20230718_083052',
	'20230718_083150',
	'20230718_083242',
	'20230718_083338',
	'20230718_083443',
	'20230718_083506',
	'20230718_083542',
	'20230718_090610',
	'20230718_090712',
	'20230718_090838',
	'20230718_090947',
	'20230718_091030',
	'20230718_091208',
	'20230718_091308',
	'20230718_100310',
	'20230718_100405',
	'20230718_100451',
	'20230718_100540',
	'20230718_100631',
	'20230718_100759',
	'20230718_100849',
	'20230718_102148',
	'20230718_102250',
	'20230718_102413',
	'20230718_102516',
	'20230718_102657',
	'20230718_102824',
	'20230718_102911',
	'20230718_103819',
	'20230718_103903',
	'20230718_104002',
	'20230718_104044',
	'20230718_104142',
	'20230718_104303',
	'20230718_104346',
	'20230718_105129',
	'20230720_013927',
	'20230720_014024',
	'20230720_014144',
	'20230720_014249',
	'20230720_014458',
	'20230720_014522',
	'20230720_014600',
	'20230720_015329',
	'20230720_015418',
	'20230720_015514',
	'20230720_015620',
	'20230720_015735',
	'20230720_015803',
	'20230720_015854',
	'20230720_015946',
	'20230720_020725',
	'20230720_020838',
	'20230720_020939',
	'20230720_021048',
	'20230720_021209',
	'20230720_021424',
	'20230720_021510',
	'20230720_022312',
	'20230720_022402',
	'20230720_022456',
	'20230720_022603',
	'20230720_022722',
	'20230720_022744',
	'20230720_022832',
	'20230720_025940',
	'20230720_030033',
	'20230720_030123',
	'20230720_030232',
	'20230720_030341',
	'20230720_030512',
	'20230720_030618',
	'20230720_030811',
	'20230720_030857',
	'20230720_030949',
	'20230720_031107',
	'20230720_031203',
	'20230720_031326',
	'20230720_031427',
	'20230720_031510',
]

# Function to calculate the distance between two bounding boxes
def bbox_distance(bbox1, bbox2):
	x1, y1, w1, h1 = bbox1
	x2, y2, w2, h2 = bbox2
	center1_x = x1 + w1 / 2
	center1_y = y1 + h1 / 2
	center2_x = x2 + w2 / 2
	center2_y = y2 + h2 / 2
	distance = ((center1_x - center2_x) ** 2 + (center1_y - center2_y) ** 2) ** 0.5
	return distance

for j_file in tqdm(glob('/data/aa/json/*.json')):
	file_name = j_file.split('/')[-1]
	# 1-person, 2-face, 3-eyes, 4-cigar, 5-phone, 6-mask, 7-bottle, 8-dog, 9-belt
	with open(j_file) as json_file:
		json_data = json.load(json_file)
		indices_to_remove = []
		for images in json_data['images']:
			belt_bool = True
			if images['file_name'].split('/')[1] in no_belt:
				belt_bool = False

			for idx, ann in enumerate(json_data['annotations']):
				if belt_bool is False and ann['category_id'] == 9 and images['id']==ann['image_id']:
					indices_to_remove.append(idx)

		# 역순으로 삭제할 인덱스들을 순회하여 삭제
		for idx in reversed(indices_to_remove):
			del json_data['annotations'][idx]
	# Group annotations by (image_id, category_id)
	grouped_annotations = {}

	for ann in json_data['annotations']:
		image_id = ann['image_id']
		category_id = ann['category_id']

		key = (image_id, category_id)

		if key not in grouped_annotations:
			grouped_annotations[key] = []

		grouped_annotations[key].append(ann)

	# Create a new list to store filtered annotations
	new_annotations = []

	# Iterate through each group of annotations
	for group_key, group_anns in grouped_annotations.items():
		if len(group_anns) < 2:
			new_annotations.extend(group_anns)
			continue

		if group_anns[0]['category_id'] == 1:
			leftmost = None
			rightmost = None
			min_x = float('inf')
			max_x = float('-inf')

			for ann in group_anns:
				x, _, _, _ = ann['bbox']
				if x < min_x:
					min_x = x
					leftmost = ann
				if x > max_x:
					max_x = x
					rightmost = ann

			new_annotations.append(leftmost)
			new_annotations.append(rightmost)
		else:
			to_remove = set()
			for i, j in combinations(range(len(group_anns)), 2):
				ann1 = group_anns[i]
				ann2 = group_anns[j]

				bbox1 = ann1['bbox']
				bbox2 = ann2['bbox']

				distance = bbox_distance(bbox1, bbox2)

				if distance <= 3:
					to_remove.add(j)  # Remove the second annotation

			# Add remaining annotations to the new list
			for i, ann in enumerate(group_anns):
				if i not in to_remove:
					new_annotations.append(ann)

	# Update the annotations in the COCO data
	json_data['annotations'] = new_annotations

	with open(f'/data/aa/change_json/{file_name}','w',encoding='utf-8') as new_json:
		json.dump(json_data, new_json, ensure_ascii=False, indent=2)